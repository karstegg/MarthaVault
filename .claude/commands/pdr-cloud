#!/bin/bash

# /pdr-cloud command implementation
# Trigger fully autonomous cloud-based daily production report processing

# Parse date argument
TARGET_DATE="$1"

# Handle relative dates
case "$TARGET_DATE" in
    "today")
        TARGET_DATE=$(date +%Y-%m-%d)
        ;;
    "yesterday")
        TARGET_DATE=$(date -d "yesterday" +%Y-%m-%d)
        ;;
    "")
        echo "‚ùå Error: Date required"
        echo "Usage: /pdr-cloud YYYY-MM-DD|today|yesterday"
        exit 1
        ;;
esac

# Validate date format
if ! [[ "$TARGET_DATE" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
    echo "‚ùå Error: Invalid date format. Use YYYY-MM-DD"
    exit 1
fi

echo "üöÄ Triggering autonomous cloud processing for $TARGET_DATE..."

# Send repository dispatch to trigger GitHub Actions
echo '{"event_type": "pdr-cloud", "client_payload": {"date": "'$TARGET_DATE'"}}' | gh api repos/karstegg/MarthaVault/dispatches --method POST --input -

if [ $? -eq 0 ]; then
    echo "üì° Repository dispatch sent successfully"
    echo "‚è≥ GitHub Actions workflow starting..."
    echo "üîó Monitor progress: https://github.com/karstegg/MarthaVault/actions"
    echo ""
    echo "Expected workflow:"
    echo "  1. Extract WhatsApp messages from Codespace"
    echo "  2. Create processing issue with @claude mention"  
    echo "  3. Claude processes reports and creates PR"
    echo "  4. Auto-validate and auto-merge PR"
    echo "  5. Auto-close issue with summary"
    echo "  6. Auto-push files to local repository"
    echo ""
    echo "‚úÖ Autonomous processing initiated for $TARGET_DATE"
    echo "üìã Files will automatically appear in your local repository"
    
    # Optional: Monitor workflow progress
    echo ""
    echo "üîÑ Monitoring workflow progress..."
    
    # Wait a moment for workflow to start
    sleep 5
    
    # Get latest workflow run
    LATEST_RUN=$(gh run list --workflow="cloud-pdr-processing.yml" --limit=1 --json databaseId --jq '.[0].databaseId')
    
    if [ -n "$LATEST_RUN" ]; then
        echo "üìä Workflow run ID: $LATEST_RUN"
        echo "üëÄ Use 'gh run watch $LATEST_RUN' to monitor in real-time"
    else
        echo "‚ÑπÔ∏è  Workflow starting - check GitHub Actions page for progress"
    fi
else
    echo "‚ùå Error: Failed to trigger GitHub Actions"
    echo "Check authentication: gh auth status"
    exit 1
fi