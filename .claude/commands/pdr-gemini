#!/bin/bash

# /pdr-gemini - Process Daily Reports using FREE Gemini AI
# Usage: /pdr-gemini YYYY-MM-DD [additional instructions]
# Example: /pdr-gemini 2025-07-12
# Example: /pdr-gemini 2025-07-12 "Focus on equipment analysis"

# Check if date argument is provided
if [ -z "$1" ]; then
    echo "âŒ Error: Date argument required"
    echo "Usage: /pdr-gemini YYYY-MM-DD [additional instructions]"
    echo "Example: /pdr-gemini 2025-07-12"
    echo "Example: /pdr-gemini 2025-07-12 \"Focus on equipment breakdown analysis\""
    exit 1
fi

# Parse date argument and additional instructions
TARGET_DATE="$1"
shift # Remove first argument (date) so $@ contains remaining arguments
ADDITIONAL_INSTRUCTIONS="$*" # Capture all remaining arguments as instructions

# Validate date format (basic check)
if ! echo "$TARGET_DATE" | grep -qE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
    echo "âŒ Error: Invalid date format. Use YYYY-MM-DD"
    echo "Example: /pdr-gemini 2025-07-12"
    exit 1
fi

# Check if gh CLI is available
if ! command -v gh &> /dev/null; then
    echo "âŒ Error: GitHub CLI (gh) not found. Please install it first."
    exit 1
fi

echo "ğŸ¤– Starting FREE Gemini AI PDR processing for $TARGET_DATE"

if [ -n "$ADDITIONAL_INSTRUCTIONS" ]; then
    echo "ğŸ“‹ Additional instructions: $ADDITIONAL_INSTRUCTIONS"
fi

echo "ğŸš€ Triggering Gemini AI workflow..."

# Trigger Gemini AI via comment on issue (bypassing workflow dispatch cache issues)
echo "Creating issue to trigger Gemini AI processing via comment..."

# Create processing request text
if [ -n "$ADDITIONAL_INSTRUCTIONS" ]; then
    PROCESSING_REQUEST="@gemini-cli Process daily production reports for $TARGET_DATE

**Additional Instructions:** $ADDITIONAL_INSTRUCTIONS

**Requirements:**
- Extract WhatsApp production data from Codespace SQLite database
- Create JSON and Markdown files for each mine site detected
- Use proper directory structure: daily_production/data/YYYY-MM/DD/
- Follow all data integrity validation rules

**Processing Date:** $TARGET_DATE"
else
    PROCESSING_REQUEST="@gemini-cli Process daily production reports for $TARGET_DATE

**Requirements:**
- Extract WhatsApp production data from Codespace SQLite database  
- Create JSON and Markdown files for each mine site detected
- Use proper directory structure: daily_production/data/YYYY-MM/DD/
- Follow all data integrity validation rules

**Processing Date:** $TARGET_DATE"
fi

# Create issue to trigger Gemini CLI workflow
ISSUE_URL=$(gh issue create \
  --title "ğŸ¤– Gemini PDR Processing: $TARGET_DATE" \
  --body "$PROCESSING_REQUEST")

echo "âœ… Created processing issue: $ISSUE_URL"

# Add comment with @gemini-pdr to trigger complete workflow
ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -o '[0-9]*$')
gh issue comment "$ISSUE_NUMBER" --body "@gemini-pdr Please process the daily production reports for $TARGET_DATE with complete data extraction and file creation."

echo "âœ… Added @gemini-pdr trigger comment"

if [ $? -eq 0 ]; then
    echo "âœ… Gemini AI workflow triggered successfully"
    echo ""
    echo "ğŸ“Š What happens next:"
    echo "1. ğŸ” WhatsApp data extraction from Codespace"
    echo "2. ğŸ¤– FREE Gemini AI processing (Google AI Studio)"
    echo "3. âš™ï¸  JSON and Markdown file generation"
    echo "4. ğŸ“ Automatic validation and file organization"
    echo "5. ğŸ”„ Automatic PR creation for review"
    echo ""
    echo "â±ï¸  Expected completion: 5-15 minutes (much faster than Claude!)"
    echo "ğŸ”— Monitor progress: https://github.com/karstegg/MarthaVault/actions"
    echo "ğŸ“‹ Issues will be created for tracking and notifications"
    echo ""
    echo "ğŸ’¡ Benefits: FREE processing vs Claude (\$0.39/day savings)"
    echo "ğŸ’° Cost: \$0 (Gemini) vs \$0.39/day (Claude) vs \$10/month (Copilot)"
    echo "âš¡ Speed: Faster processing with Gemini 2.0 Flash Exp model"
else
    echo "âŒ Failed to trigger Gemini AI workflow"
    echo "ğŸ” Check GitHub CLI authentication and repository access"
    exit 1
fi