name: Autonomous Basic

on:
  issues:
    types: [opened]

jobs:
  basic-autonomous:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, 'Autonomous Process WhatsApp Reports')
    
    steps:
    - name: Parse Issue Date
      id: parse
      run: |
        echo "Autonomous workflow triggered successfully"
        echo "Issue title: ${{ github.event.issue.title }}"
        
        # Extract date from issue title
        issue_title="${{ github.event.issue.title }}"
        if [[ "$issue_title" =~ ([0-9]{4}-[0-9]{2}-[0-9]{2}) ]]; then
          report_date="${BASH_REMATCH[1]}"
          echo "Found report date: $report_date"
          echo "report_date=$report_date" >> $GITHUB_OUTPUT
        else
          echo "No valid date found in issue title"
          exit 1
        fi
        
    - name: Manage Codespace
      id: codespace
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        echo "Managing Codespace for autonomous processing..."
        
        # Check for existing Codespaces
        echo "Checking Codespace status..."
        CODESPACE_DATA=$(gh codespace list --repo ${{ github.repository }} --json name,state,displayName 2>/dev/null || echo "[]")
        echo "Codespace data: $CODESPACE_DATA"
        
        # Look for available or starting Codespace
        CODESPACE_NAME=$(echo "$CODESPACE_DATA" | jq -r '.[] | select(.state=="Available" or .state=="Starting") | .name' | head -1)
        
        if [ -z "$CODESPACE_NAME" ]; then
          echo "No active Codespace found. Checking for stopped Codespaces..."
          STOPPED_CODESPACE=$(echo "$CODESPACE_DATA" | jq -r '.[] | select(.state=="Shutdown") | .name' | head -1)
          
          if [ -n "$STOPPED_CODESPACE" ]; then
            echo "Starting stopped Codespace: $STOPPED_CODESPACE"
            gh codespace start -c "$STOPPED_CODESPACE"
            CODESPACE_NAME="$STOPPED_CODESPACE"
            
            echo "Waiting for Codespace to be ready..."
            for i in {1..24}; do
              sleep 15
              STATE=$(gh codespace list --repo ${{ github.repository }} --json name,state | jq -r ".[] | select(.name==\"$CODESPACE_NAME\") | .state")
              echo "Attempt $i: Codespace state is $STATE"
              
              if [ "$STATE" = "Available" ]; then
                echo "Codespace is ready!"
                break
              elif [ $i -eq 24 ]; then
                echo "Timeout waiting for Codespace to be ready"
                exit 1
              fi
            done
          else
            echo "No Codespaces found. This requires manual Codespace creation."
            echo "Please create a Codespace for this repository first."
            exit 1
          fi
        fi
        
        echo "Using Codespace: $CODESPACE_NAME"
        echo "codespace_status=ready" >> $GITHUB_OUTPUT
        echo "codespace_name=$CODESPACE_NAME" >> $GITHUB_OUTPUT
        
    - name: Extract WhatsApp Data from Codespace
      id: extract
      if: steps.codespace.outputs.codespace_status == 'ready'
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        echo "Extracting WhatsApp data from Codespace..."
        echo "Target Date: ${{ steps.parse.outputs.report_date }}"
        echo "Codespace: ${{ steps.codespace.outputs.codespace_name }}"
        
        # Wait a moment for Codespace services to initialize
        echo "Waiting for Codespace services to initialize..."
        sleep 30
        
        # Start MCP server and extract data using existing scripts
        echo "Starting WhatsApp MCP server and extracting data..."
        gh codespace ssh -c "${{ steps.codespace.outputs.codespace_name }}" -- "
          cd /workspaces/MarthaVault && 
          echo 'Starting MCP server...' &&
          bash .devcontainer/startup-autonomous.sh &&
          sleep 10 &&
          echo 'Extracting WhatsApp data...' &&
          python3 .devcontainer/codespace-direct-processing.py ${{ steps.parse.outputs.report_date }} --extract-only
        " > whatsapp_data.txt 2>&1
        
        echo "Extraction command completed. Checking results..."
        
        # Check if we got valid data
        if [ -s whatsapp_data.txt ]; then
          echo "WhatsApp data file created. Checking content..."
          
          # Look for data indicators
          if grep -q "WHATSAPP_DATA_START\|From:\|Content:" whatsapp_data.txt; then
            echo "âœ… WhatsApp data extracted successfully"
            echo "extraction_status=success" >> $GITHUB_OUTPUT
            echo "ğŸ“Š Data preview:"
            head -20 whatsapp_data.txt
          else
            echo "âŒ Data file exists but appears to contain errors"
            echo "ğŸ“„ Full output for debugging:"
            cat whatsapp_data.txt
            echo "extraction_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "âŒ WhatsApp data extraction failed - no output file"
          echo "extraction_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Process Reports with Gemini
      id: process
      if: steps.extract.outputs.extraction_status == 'success'
      run: |
        echo "Processing reports with Gemini would happen here..."
        echo "For now, displaying extracted WhatsApp data"
        echo "Full data:"
        cat whatsapp_data.txt
        echo "processing_status=success" >> $GITHUB_OUTPUT
        
    - name: Report Final Status
      if: always()
      run: |
        echo "AUTONOMOUS WORKFLOW COMPLETE"
        echo "Report Date: ${{ steps.parse.outputs.report_date }}"
        echo "Codespace Status: ${{ steps.codespace.outputs.codespace_status }}"
        
        if [ "${{ steps.codespace.outputs.codespace_status }}" = "ready" ]; then
          echo "Codespace Name: ${{ steps.codespace.outputs.codespace_name }}"
          echo "WhatsApp Extraction: ${{ steps.extract.outputs.extraction_status }}"
          echo "Gemini Processing: ${{ steps.process.outputs.processing_status }}"
          
          if [ "${{ steps.extract.outputs.extraction_status }}" = "success" ] && [ "${{ steps.process.outputs.processing_status }}" = "success" ]; then
            echo "ğŸ‰ SUCCESS: Complete autonomous processing pipeline working!"
            echo "âœ… Codespace activated and managed automatically"
            echo "âœ… WhatsApp MCP data extracted successfully"
            echo "âœ… Ready for future enhancement with Gemini processing"
          else
            echo "âŒ FAILURE: Processing incomplete - check logs above"
            echo "ğŸ” Codespace Status: ready"
            echo "ğŸ” Extraction Status: ${{ steps.extract.outputs.extraction_status }}"
            echo "ğŸ” Processing Status: ${{ steps.process.outputs.processing_status }}"
          fi
        else
          echo "âŒ Codespace management failed"
          echo "ğŸ” Status: ${{ steps.codespace.outputs.codespace_status }}"
          echo "ğŸ’¡ Check if Codespace exists and PAT token has proper permissions"
        fi