name: Autonomous Simple Test

on:
  issues:
    types: [opened]

jobs:
  autonomous-test:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, 'Autonomous Process WhatsApp Reports')
    
    steps:
    - name: Parse Issue
      id: parse
      run: |
        issue_title="${{ github.event.issue.title }}"
        echo "Processing: $issue_title"
        
        if [[ "$issue_title" =~ ([0-9]{4}-[0-9]{2}-[0-9]{2}) ]]; then
          report_date="${BASH_REMATCH[1]}"
          echo "Found date: $report_date"
          echo "report_date=$report_date" >> $GITHUB_OUTPUT
        else
          echo "No date found"
          exit 1
        fi

    - name: Check Codespace
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Looking for active Codespace..."
        CODESPACE_NAME=$(gh codespace list --repo ${{ github.repository }} --json name,state | jq -r '.[] | select(.state=="Available") | .name' | head -1)
        
        if [ -z "$CODESPACE_NAME" ]; then
          echo "No active Codespace found"
          echo "CODESPACE_STATUS=not_found" >> $GITHUB_ENV
        else
          echo "Found Codespace: $CODESPACE_NAME"  
          echo "CODESPACE_STATUS=found" >> $GITHUB_ENV
          echo "CODESPACE_NAME=$CODESPACE_NAME" >> $GITHUB_ENV
        fi

    - name: Test Codespace Connection
      if: env.CODESPACE_STATUS == 'found'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Testing connection to Codespace: $CODESPACE_NAME"
        # Test basic connectivity
        gh codespace ssh -c "$CODESPACE_NAME" -- "echo 'Codespace connection successful'"
        echo "Connection test completed"

    - name: Report Results
      run: |
        echo "AUTONOMOUS SYSTEM TEST REPORT"
        echo "Date parsed: ${{ steps.parse.outputs.report_date }}"
        echo "Codespace status: $CODESPACE_STATUS"
        if [ "$CODESPACE_STATUS" = "found" ]; then
          echo "Codespace name: $CODESPACE_NAME"
          echo "Connection: Tested successfully"
        fi
        echo "Test completed successfully"